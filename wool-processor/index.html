<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BW - Receipt Processor</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="../style.css">
    <style>
        :root {
            --primary-color: #10b981;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
            --text-color: #f8fafc;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
        }

        /* Hub Standard Header */
        header { padding: 20px; text-align: center; position: relative; }
        header h1 { font-size: 1.6rem; margin: 0; color: white; }
        header p { 
            font-size: 1.1rem; font-weight: 800; color: var(--primary-color); 
            text-transform: uppercase; letter-spacing: 0.15em; margin: 5px 0 0 0;
        }

        .hub-link { 
            position: fixed; top: 15px; right: 15px; 
            background: var(--card-bg); color: var(--primary-color); 
            padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; 
            font-weight: bold; text-decoration: none; border: 1px solid var(--border-color); 
            z-index: 1000;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* Processor UI */
        .upload-zone {
            background: var(--card-bg); border: 2px dashed var(--border-color);
            border-radius: 16px; padding: 40px; text-align: center; cursor: pointer;
            transition: 0.3s; margin-bottom: 20px;
        }
        .upload-zone:hover { border-color: var(--primary-color); }

        .progress-bar { height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden; margin: 20px 0; display: none; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }

        /* Data Table */
        .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left; }
        th { background: #1e293b; color: var(--primary-color); padding: 12px; border-bottom: 2px solid var(--border-color); text-transform: uppercase; font-size: 0.7rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        
        .btn-download {
            display: inline-block; background: #3b82f6; color: white; padding: 12px 24px;
            border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 20px;
        }

        [contenteditable="true"]:focus { outline: 1px solid var(--primary-color); background: #0f172a; }
    </style>
</head>
<body>

    <a href="../index.html" class="hub-link">‚Üê HUB</a>

    <header>
        <h1>Receipt Processor</h1>
        <p>Bromyard Depot</p>
    </header>

    <div class="container">
        <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">üßæ</div>
            <p style="font-weight: bold; margin: 0;">Upload Receipt Images</p>
            <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">Supports Batch JPG/PNG</p>
            <input type="file" id="imageInput" multiple accept="image/*" style="display:none;">
        </div>

        <div id="progressArea" class="progress-bar">
            <div id="progressBar" class="progress-fill"></div>
        </div>
        <p id="statusText" style="text-align: center; font-size: 0.8rem; color: #94a3b8; font-style: italic;"></p>

        <div id="resultsArea" style="display:none;">
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Producer</th>
                            <th>Reg No</th>
                            <th>Clip</th>
                            <th>Bag</th>
                            <th>Gross</th>
                            <th>Net</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
            <div style="text-align: center;">
                <button onclick="downloadCSV()" class="btn-download">Download CSV for Excel</button>
            </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('imageInput');
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const resultsArea = document.getElementById('resultsArea');
        const tableBody = document.getElementById('dataTableBody');

        let processedData = [];
        let globalBagCounter = 1;

        input.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            progressArea.style.display = 'block';
            resultsArea.style.display = 'none';
            processedData = [];
            globalBagCounter = 1;

            for (let i = 0; i < files.length; i++) {
                let percent = Math.round(((i + 1) / files.length) * 100);
                progressBar.style.width = `${percent}%`;
                statusText.innerText = `OCR: Reading sheet ${i + 1} of ${files.length}...`;
                
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                const { data: { text } } = await worker.recognize(files[i]);
                await worker.terminate();
                
                extractData(text);
            }

            renderTable();
            statusText.innerText = "‚úÖ Batch Processing Complete";
            resultsArea.style.display = 'block';
        });

        function extractData(text) {
            let clean = text.replace(/I/g, '1').replace(/l/g, '1');
            const regMatch = clean.match(/(?:Reg|No)\.?\s*([A-Z0-9]+)/i);
            const nameMatch = clean.match(/(?:Name)\.?\s*([A-Z\s]+)/i);

            const producer = nameMatch ? nameMatch[1].trim() : "New Producer";
            const regNo = regMatch ? regMatch[1] : "---";

            const weights = clean.match(/\b\d{2,3}\b/g);
            if (weights) {
                weights.forEach(w => {
                    const gross = parseInt(w);
                    if (gross > 40 && gross < 250) {
                        processedData.push({
                            name: producer,
                            reg: regNo,
                            clip: "1",
                            bag: globalBagCounter++,
                            gross: gross,
                            net: gross - 1
                        });
                    }
                });
            }
        }

        function renderTable() {
            tableBody.innerHTML = processedData.map((row, i) => `
                <tr>
                    <td contenteditable="true">${row.name}</td>
                    <td contenteditable="true" style="color:#10b981; font-family:monospace;">${row.reg}</td>
                    <td contenteditable="true">${row.clip}</td>
                    <td style="color:#64748b;">${row.bag}</td>
                    <td contenteditable="true" style="font-weight:bold;">${row.gross}</td>
                    <td style="font-weight:bold; color:white;">${row.net}</td>
                </tr>
            `).join('');
        }

        window.downloadCSV = function() {
            let csv = "Producer,RegNo,Clip,Bag,Gross,Net\n";
            processedData.forEach(r => csv += `${r.name},${r.reg},${r.clip},${r.bag},${r.gross},${r.net}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Receipts_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
