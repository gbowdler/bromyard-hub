<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BW - Bromyard Utility Suite</title>
    
    <link rel="icon" type="image/png" href="bw-logo.png">
    <link rel="stylesheet" href="style.css">
    <link rel="apple-touch-icon" href="bw-logo.png">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Base styles from style.css */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body {
            background-color: #0f172a;
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; color: #f8fafc; padding: 40px 20px;
        }
        .avatar { width: 100px; height: auto; margin-bottom: 15px; }
        .links { display: flex; flex-direction: column; gap: 12px; }
        .link-card {
            background: #1e293b; padding: 18px; border-radius: 12px;
            text-decoration: none; color: white; font-weight: 600;
            border: 1px solid #334155; transition: all 0.2s ease;
            display: block; text-align: center;
        }
        .link-card:hover { border-color: #10b981; transform: translateY(-2px); background: #243147; }
        .socials { margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .socials a { color: #64748b; text-decoration: none; font-size: 0.85rem; border-bottom: 1px solid transparent; transition: 0.3s; }
        .socials a:hover { color: #10b981; border-bottom: 1px solid #10b981; }
        .version-tag { font-size: 0.65rem; color: #334155; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 20px; }
        
        /* Page-specific overrides */
        .container { padding: 5px 20px; }
        
        .section-title { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin: 12px 0 6px; text-align: left; }
        
        /* Ultra-compact header */
        .profile { margin-bottom: 8px; }
        .profile img { width: 50px; margin-bottom: 4px; }
        .profile h1 { font-size: 1.3rem; margin-bottom: 0px; }
        .profile p { 
            font-size: 1.05rem; 
            font-weight: 800; 
            color: #10b981; 
            text-transform: uppercase; 
            margin-bottom: 4px;
        }

        .link-card { padding: 12px; margin-bottom: 6px; font-size: 0.9rem; }

        /* Fixed Expanding Notepad */
        .btn-note-toggle { 
            background: #1e293b; border: 1px solid #334155; color: #f1f5f9; 
            font-size: 0.9rem; cursor: pointer; width: 100%; padding: 12px; 
            border-radius: 10px; font-weight: 600; display: flex; justify-content: center; 
            align-items: center; 
        }

        .note-content { 
            display: none; /* Changed from max-height to display for a cleaner hide */
            background: #1e293b; border: 1px solid #10b981; border-top: none;
            border-radius: 0 0 12px 12px; padding: 12px; margin-top: -2px;
        }
        .note-content.open { display: block; }
        #depotNotes { width: 100%; height: 180px; background: #0f172a; color: #f1f5f9; border: 1px solid #334155; border-radius: 8px; padding: 8px; font-size: 0.85rem; resize: none; box-sizing: border-box; }

        .btn-scanner { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; font-weight: 600; margin-bottom: 6px; cursor: pointer; font-size: 0.9rem; width: 100%; }

        .btn-first-aid { background: #008b45; color: white; font-weight: bold; }
        .btn-emergency { background: #000; color: #ef4444; border: 2px solid #ef4444 !important; font-weight: 800; margin-top: 4px; padding: 12px; }
        .w3w-box { background: #e11f26; color: white; padding: 6px 10px; border-radius: 6px; font-family: monospace; font-size: 0.9rem; display: inline-block; margin-top: 4px; font-weight: bold; }
        
        .contact-input { 
            width: 100%; padding: 8px; margin: 4px 0; background: #0f172a; 
            color: white; border: 1px solid #334155; border-radius: 6px; 
            font-size: 0.85rem; box-sizing: border-box;
        }
        
        .edit-mode { background: rgba(16, 185, 129, 0.1); border-color: #10b981 !important; }
    </style>
</head>
<body>
    <div class="container">
        <header class="profile">
            <button onclick="openSettings()" style="position: fixed; top: 15px; right: 15px; background: #1e293b; color: #f1f5f9; padding: 10px 14px; border-radius: 8px; border: 1px solid #334155; font-size: 1.2rem; cursor: pointer; z-index: 1000;">⚙️</button>
            <img src="bw-logo.png" class="avatar" alt="British Wool Logo">
            <h1>Bromyard Depot</h1>
            <p>Utility Suite</p>
        </header>

        <main class="links">
            <div class="section-title">Data Processing</div>
            <a href="wool-processor/index.html" class="link-card">Wool Intake Receipt Processor</a>
            <a href="bale-extractor/index.html" class="link-card">Bale Packing Sheet Extractor</a>
            <a href="bale-tracker/index.html" class="link-card">Bale Transportation Tracker</a>

            <div class="note-wrapper" style="margin-top: 8px;">
                <button class="btn-note-toggle" id="noteToggle">
                    Depot Notepad <span id="toggleIcon" style="margin-left: 8px;">▼</span>
                </button>
                <div class="note-content" id="noteContent">
                    <textarea id="depotNotes" placeholder="Record shift notes here..."></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span id="saveStatus" style="font-size:0.6rem; color:#64748b;">Saved to device</span>
                        <button onclick="shareNote()" style="background:none; border:none; color:#10b981; font-weight:bold; font-size:0.7rem; cursor:pointer;">SHARE</button>
                    </div>
                </div>
            </div>

            <div class="section-title">Health & Safety</div>
            <button class="link-card btn-emergency" style="width: 100%; cursor: pointer;" onclick="showEmergencyDetails()">EMERGENCY DETAILS</button>
            <a href="#" class="link-card btn-first-aid">First Aid Kit Log</a>
            <button id="scanBtn" class="btn-scanner">Scan Machine QR Code</button>
            <div id="reader"></div>
            
            <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreFromBackup(event)">
        </main>
        
        <footer class="socials" style="margin-top:10px;">
            <a href="print-qr.html" style="color: #10b981; font-size: 0.7rem; text-decoration: none;">Print QR Poster</a>
            <div class="version-tag" style="font-size: 0.6rem; color: #475569; margin-top: 2px;">Build v1.3.0-Bromyard</div>
        </footer>
    </div>

    <script>
        const DEFAULT_LOCATION = "///intent.reeling.mops";
        const DEFAULT_CONTACTS = [
            { role: "Depot Manager", name: "Gareth Bowdler", phone: "07929 667272" },
            { role: "First Aider", name: "Gareth Bowdler", phone: "07929 667272" },
            { role: "H&S Manager", name: "", phone: "" }
        ];

        // Load saved contacts or use defaults
        function getEmergencyContacts() {
            const saved = localStorage.getItem('bromyard_emergency_contacts');
            return saved ? JSON.parse(saved) : DEFAULT_CONTACTS;
        }

        function getDepotLocation() {
            return localStorage.getItem('bromyard_w3w_location') || DEFAULT_LOCATION;
        }

        function saveEmergencyContacts(contacts) {
            localStorage.setItem('bromyard_emergency_contacts', JSON.stringify(contacts));
        }

        function saveDepotLocation(location) {
            localStorage.setItem('bromyard_w3w_location', location);
        }

        const noteToggle = document.getElementById('noteToggle');
        const noteContent = document.getElementById('noteContent');
        const noteArea = document.getElementById('depotNotes');
        const saveStatus = document.getElementById('saveStatus');

        // Fixed Toggle Logic
        noteToggle.onclick = () => {
            const isOpen = noteContent.classList.toggle('open');
            document.getElementById('toggleIcon').innerText = isOpen ? '▲' : '▼';
            // Round the top button corners and add green border when open
            if (isOpen) {
                noteToggle.style.borderRadius = "10px 10px 0 0";
                noteToggle.style.borderColor = "#10b981";
            } else {
                noteToggle.style.borderRadius = "10px";
                noteToggle.style.borderColor = "#334155";
            }
            if(isOpen) noteArea.focus();
        };

        noteArea.value = localStorage.getItem('bromyard_notes') || "";
        noteArea.addEventListener('input', () => {
            localStorage.setItem('bromyard_notes', noteArea.value);
            saveStatus.innerText = "Saving...";
            setTimeout(() => { saveStatus.innerText = "Saved to device"; }, 500);
        });

        async function shareNote() {
            if (!noteArea.value) return alert("Note is empty!");
            if (navigator.share) {
                try { await navigator.share({ title: 'Bromyard Depot Note', text: noteArea.value }); } catch (e) {}
            } else {
                navigator.clipboard.writeText(noteArea.value);
                alert("Note copied!");
            }
        }
        
        function openSettings() {
            const modal = `
                <div id="settingsModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; padding:15px;">
                    <div style="background:#1e293b; width:100%; max-width:350px; padding:20px; border-radius:16px; border:1px solid #334155;">
                        <h2 style="margin-top:0; color:#10b981; font-size:1.2rem;">Settings</h2>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #fff; font-size: 0.85rem; display: block; margin-bottom: 10px;">Backup & Restore</strong>
                            <button onclick="createBackup()" style="width:100%; padding:12px; background:#334155; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-bottom:8px;">Export Backup</button>
                            <button onclick="document.getElementById('restoreInput').click()" style="width:100%; padding:12px; background:#334155; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Restore from Backup</button>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid #334155; margin-bottom: 15px;">
                            <strong style="color: #94a3b8; font-size: 0.7rem; display: block; margin-bottom: 4px;">VERSION</strong>
                            <div style="color: #fff; font-size: 0.85rem; font-weight: 600;">Build v1.3.0-Bromyard</div>
                        </div>
                        
                        <button onclick="closeSettings()" style="width:100%; padding:12px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">CLOSE</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.remove();
        }

        function showEmergencyDetails() {
            const contacts = getEmergencyContacts();
            const location = getDepotLocation();
            const isEditing = false;
            
            renderEmergencyModal(contacts, location, isEditing);
        }

        function renderEmergencyModal(contacts, location, isEditing) {
            // Remove existing modal if present
            const existing = document.getElementById('cModal');
            if (existing) existing.remove();

            let contactsHtml = '';
            
            if (isEditing) {
                contactsHtml = contacts.map((c, idx) => `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid #334155;">
                        <input type="text" class="contact-input edit-mode" id="role_${idx}" value="${c.role}" placeholder="Role (e.g. Depot Manager)">
                        <input type="text" class="contact-input edit-mode" id="name_${idx}" value="${c.name}" placeholder="Name">
                        <input type="tel" class="contact-input edit-mode" id="phone_${idx}" value="${c.phone}" placeholder="Phone Number">
                    </div>`).join('');
            } else {
                contactsHtml = contacts.map(c => {
                    if (!c.name && !c.phone) return ''; // Skip empty contacts
                    return `
                    <div style="margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 6px;">
                        <strong style="color: #10b981; font-size: 0.65rem;">${c.role}</strong>
                        <div style="font-size: 1rem; font-weight: bold; color: #fff;">${c.name || 'Not set'}</div>
                        ${c.phone ? `<a href="tel:${c.phone.replace(/\s/g, '')}" style="color: #3b82f6; text-decoration: none; font-size: 1rem;">${c.phone}</a>` : '<span style="color: #64748b; font-size: 0.85rem;">No phone number</span>'}
                    </div>`}).join('');
            }

            const locationDisplay = isEditing 
                ? `<input type="text" class="contact-input edit-mode" id="w3w_location" value="${location}" placeholder="///word.word.word" style="font-family: monospace;">`
                : `<a href="https://what3words.com/${location}" target="_blank" style="text-decoration: none;">
                     <div class="w3w-box" style="cursor: pointer;">${location}</div>
                   </a>`;

            const actionButton = isEditing
                ? `<button onclick="saveEmergencyChanges()" style="width:100%; padding:12px; background:#10b981; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px;">SAVE CHANGES</button>`
                : `<button onclick="toggleEditMode()" style="width:100%; padding:10px; background:#334155; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px;">EDIT DETAILS</button>`;

            const modal = `
                <div id="cModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; padding:15px; overflow-y: auto;">
                    <div style="background:#1e293b; width:100%; max-width:350px; padding:20px; border-radius:16px; border:1px solid #ef4444; max-height: 90vh; overflow-y: auto;">
                        <h2 style="margin-top:0; color:#ef4444; font-size:1.2rem;">Emergency Details</h2>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(225, 31, 38, 0.1); border-radius: 8px;">
                            <strong style="color: #fff; font-size: 0.75rem; display: block; margin-bottom: 4px;">What3Words Location:</strong>
                            ${locationDisplay}
                            ${!isEditing ? '<div style="font-size: 0.65rem; color: #94a3b8; margin-top: 6px;">Tap to open in What3Words app</div>' : ''}
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #fff; font-size: 0.75rem; display: block; margin-bottom: 8px;">Emergency Contacts:</strong>
                            ${contactsHtml}
                        </div>
                        
                        ${actionButton}
                        <button onclick="closeEmergencyModal()" style="width:100%; padding:10px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px;">CLOSE</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function toggleEditMode() {
            const contacts = getEmergencyContacts();
            const location = getDepotLocation();
            renderEmergencyModal(contacts, location, true);
        }

        function saveEmergencyChanges() {
            const contacts = getEmergencyContacts();
            const updatedContacts = contacts.map((c, idx) => ({
                role: document.getElementById(`role_${idx}`).value,
                name: document.getElementById(`name_${idx}`).value,
                phone: document.getElementById(`phone_${idx}`).value
            }));
            
            const updatedLocation = document.getElementById('w3w_location').value;
            
            saveEmergencyContacts(updatedContacts);
            saveDepotLocation(updatedLocation);
            
            // Auto-backup after updating contacts
            createBackup();
            
            // Show success and return to view mode
            alert('Emergency details saved! Backup created.');
            renderEmergencyModal(updatedContacts, updatedLocation, false);
        }
        
        function createBackup() {
            const backup = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                data: {
                    contacts: localStorage.getItem('bromyard_emergency_contacts') || "[]",
                    location: localStorage.getItem('bromyard_w3w_location') || "",
                    notes: localStorage.getItem('bromyard_notes') || "",
                    season: localStorage.getItem('baleTrackerSeason') || "{}"
                }
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bromyard-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Backup file downloaded!');
        }
        
        function restoreFromBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.version || !backup.data) {
                        alert('Invalid backup file format!');
                        return;
                    }
                    
                    // Confirm before restoring
                    if (!confirm('This will replace ALL current data with the backup.\n\nAre you sure?')) {
                        return;
                    }
                    
                    // Restore all data
                    if (backup.data.contacts) localStorage.setItem('bromyard_emergency_contacts', backup.data.contacts);
                    if (backup.data.location) localStorage.setItem('bromyard_w3w_location', backup.data.location);
                    if (backup.data.notes) localStorage.setItem('bromyard_notes', backup.data.notes);
                    if (backup.data.season) localStorage.setItem('baleTrackerSeason', backup.data.season);
                    
                    alert('Backup restored successfully!\n\nReloading page...');
                    location.reload();
                    
                } catch (error) {
                    alert('Error reading backup file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input so same file can be selected again
            event.target.value = '';
        }

        function closeEmergencyModal() {
            document.getElementById('cModal').remove();
        }
    </script>
</body>
</html>
