<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BW - Bale Tracker</title>
    <style>
        :root {
            --primary-color: #10b981; /* Emerald */
            --bg-color: #0f172a;    /* Deep Navy */
            --card-bg: #1e293b;     /* Slate */
            --text-color: #f8fafc;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overscroll-behavior-y: none; 
        }

        /* Standardised Hub Header */
        header {
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header h1 { font-size: 1.6rem; margin: 0; color: white; }
        header p { 
            font-size: 1.1rem; font-weight: 800; color: var(--primary-color); 
            text-transform: uppercase; letter-spacing: 0.15em; margin: 5px 0 0 0;
        }

        .back-link { 
            position: fixed; top: 15px; right: 15px; 
            background: var(--card-bg); color: var(--primary-color); 
            padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; 
            font-weight: bold; text-decoration: none; border: 1px solid var(--border-color); 
            z-index: 1000;
        }

        .container {
            max-width: 600px;
            margin: 0 auto 40px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .hidden { display: none !important; }

        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        input, select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid var(--border-color); border-radius: 8px;
            background: #0f172a; color: white;
            font-size: 16px; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            margin-bottom: 10px; transition: all 0.2s;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #334155; color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .status-bar {
            background-color: #0f172a; padding: 15px; border-radius: 8px;
            margin-bottom: 20px; text-align: center; font-weight: bold;
            border: 1px solid var(--border-color);
        }
        .status-warning { background-color: #eab308; color: black; }
        .status-danger { background-color: var(--danger-color); color: white; }

        #manifestList { list-style: none; padding: 0; margin-top: 20px; }
        #manifestList li {
            background-color: #0f172a; border-bottom: 1px solid var(--border-color);
            padding: 12px; display: flex; justify-content: space-between; align-items: center;
            border-radius: 8px; margin-bottom: 8px;
        }
        
        .bale-info { font-weight: bold; color: var(--primary-color); display: block; }
        .bale-details { font-size: 0.85rem; color: #94a3b8; }

        .btn-list-delete {
            background: rgba(239, 68, 68, 0.1); color: #ef4444;
            padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.2);
            width: auto; margin: 0; font-size: 14px;
        }

        .input-group { display: flex; gap: 10px; }
        .input-group > div { flex: 1; }

        #customModalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            width: 85%; max-width: 300px; text-align: center; border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>

    <div id="customModalOverlay" class="hidden">
        <div class="modal-box">
            <div id="modalMessage" style="margin-bottom: 20px;">Are you sure?</div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-danger" id="modalConfirmBtn">Yes</button>
            </div>
        </div>
    </div>

    <header>
        <a href="../index.html" class="back-link">‚Üê HUB</a>
        <h1>Bale Tracker</h1>
        <p>Bromyard Depot</p>
    </header>

    <div class="container">
        
        <div id="haulierSection">
            <h2 style="font-size: 1.1rem; margin-top: 0; color: #fff;">Transport Haulier</h2>
            <label>Who is transporting?</label>
            <select id="haulierSelect" onchange="checkOtherHaulier()">
                <option value="Nigel|17">Nigel (Max 17)</option>
                <option value="Mervyn Thomas|14">Mervyn Thomas (Max 14)</option>
                <option value="Other">Other...</option>
            </select>

            <div id="otherHaulierInputs" class="hidden">
                <label>Haulier Name:</label>
                <input type="text" id="otherName" placeholder="e.g. John Smith">
                <label>Max Capacity:</label>
                <input type="number" id="otherLimit" value="14">
            </div>

            <button type="button" class="btn-primary" onclick="startLoading()">Start Loading</button>
        </div>

        <div id="entrySection" class="hidden">
            <div id="statusBar" class="status-bar">Loading: 0 / 0</div>

            <div class="input-group">
                <div style="flex: 2;">
                    <label>Bale Number:</label>
                    <input type="tel" id="baleNumber" placeholder="e.g. 101">
                </div>
                <div>
                    <label>Type:</label>
                    <select id="clusterSize" onchange="handleClusterChange()">
                        <option value="1" selected>Single</option>
                        <option value="2">2BC</option>
                        <option value="3">3BC</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
            </div>

            <div id="customSizeContainer" class="hidden">
                <label>Custom Size:</label>
                <input type="number" id="customSizeInput">
            </div>

            <div id="refInputContainer" class="hidden">
                <label>Reference (Optional Tag):</label>
                <input type="text" id="clusterRef" placeholder="e.g. Front Stack">
            </div>

            <button type="button" class="btn-primary" onclick="addBale()">Add Bale</button>

            <h3 style="font-size: 1rem; margin-top: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Load List</h3>
            <ul id="manifestList"></ul>

            <button type="button" class="btn-success" style="margin-top: 20px;" onclick="finishAndShare()">Share / Save CSV</button>
            <button type="button" class="btn-secondary" onclick="copyManifest()">Copy to Clipboard</button>
            <button type="button" class="btn-danger" style="margin-top: 20px; opacity: 0.6;" onclick="requestReset()">New Load</button>
        </div>
    </div>

    <script>
        let haulierName = ""; let maxLimit = 0; let currentCount = 0; let manifestData = []; 

        function showModal(message, confirmCallback) {
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('modalConfirmBtn').onclick = () => { confirmCallback(); closeModal(); };
            document.getElementById('customModalOverlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('customModalOverlay').classList.add('hidden'); }

        function checkOtherHaulier() {
            document.getElementById('otherHaulierInputs').classList.toggle('hidden', document.getElementById('haulierSelect').value !== 'Other');
        }

        function startLoading() {
            const select = document.getElementById('haulierSelect');
            if (select.value === 'Other') {
                haulierName = document.getElementById('otherName').value.trim() || "Other";
                maxLimit = parseInt(document.getElementById('otherLimit').value) || 14;
            } else {
                const parts = select.value.split('|');
                haulierName = parts[0];
                maxLimit = parseInt(parts[1]);
            }
            document.getElementById('haulierSection').classList.add('hidden');
            document.getElementById('entrySection').classList.remove('hidden');
            updateStatusUi();
            document.getElementById('baleNumber').focus();
        }

        function handleClusterChange() {
            const size = document.getElementById('clusterSize').value;
            document.getElementById('customSizeContainer').classList.toggle('hidden', size !== 'Custom');
            document.getElementById('refInputContainer').classList.toggle('hidden', size === '1');
        }

        function addBale() {
            const numInput = document.getElementById('baleNumber');
            const baleNum = parseInt(numInput.value);
            if (isNaN(baleNum)) { alert("Invalid Bale #"); return; }
            if (manifestData.some(item => item.number === baleNum)) { alert("Bale already added!"); return; }

            const sizeSelect = document.getElementById('clusterSize').value;
            let typeStr = sizeSelect === 'Custom' ? document.getElementById('customSizeInput').value + "BC" : (sizeSelect === "1" ? "Single" : sizeSelect + "BC");
            
            manifestData.push({ number: baleNum, type: typeStr, ref: document.getElementById('clusterRef').value, val: 1 });
            currentCount++;
            numInput.value = ""; numInput.focus();
            updateStatusUi(); renderManifestList();
        }

        function renderManifestList() {
            const list = document.getElementById('manifestList'); list.innerHTML = "";
            [...manifestData].reverse().forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="list-text"><span class="bale-info">#${item.number}</span><span class="bale-details">${item.type} ${item.ref ? '['+item.ref+']' : ''}</span></div>
                                <button class="btn-list-delete" onclick="requestDelete(${item.number})">Delete</button>`;
                list.appendChild(li);
            });
        }

        function updateStatusUi() {
            const bar = document.getElementById('statusBar');
            bar.textContent = `Loading: ${currentCount} / ${maxLimit} (${haulierName})`;
            bar.className = 'status-bar ' + (currentCount > maxLimit ? 'status-danger' : (currentCount === maxLimit ? 'status-warning' : ''));
        }

        function requestDelete(n) { showModal(`Delete Bale #${n}?`, () => {
            const idx = manifestData.findIndex(i => i.number === n);
            currentCount--; manifestData.splice(idx, 1); updateStatusUi(); renderManifestList();
        });}

        function requestReset() { showModal("Start new load?", () => { location.reload(); });}

        async function finishAndShare() {
            if (manifestData.length === 0) return;
            let csv = "Bale Number,Type,Reference\n" + manifestData.map(i => `${i.number},${i.type},${i.ref}`).join("\n");
            const file = new File([csv], `Bale_Manifest_${new Date().toISOString().slice(0,10)}.csv`, { type: "text/csv" });
            if (navigator.share) await navigator.share({ files: [file], title: "Bale Manifest" });
        }

        function copyManifest() {
            let text = manifestData.map(i => `#${i.number} - ${i.type}`).join("\n");
            navigator.clipboard.writeText(text).then(() => alert("Copied!"));
        }
    </script>
</body>
</html>
